<script>
  // API path on Vercel
  const WEB_APP_URL = '/api/proxy';
  let currentType = 'ALL';

  function setType(t) {
    currentType = t;
    document.getElementById('f-all').classList.toggle('on', t === 'ALL');
    document.getElementById('f-d').classList.toggle('on', t === 'D');
    document.getElementById('f-p').classList.toggle('on', t === 'P');
    load();
  }

  function todayISO() {
    var d = new Date();
    var m = String(d.getMonth() + 1).padStart(2, '0');
    var day = String(d.getDate()).padStart(2, '0');
    return d.getFullYear() + '-' + m + '-' + day;
  }

  function mapsLink(addr) {
    return 'https://www.google.com/maps?q=' + encodeURIComponent(addr || '');
  }

  function card(item) {
    var win = item.window || '(no window)';
    var kindTxt = item.kind === 'D' ? 'Delivery' : 'Pickup';
    var done = item.isDone ? 'done' : '';
    var btnClass = item.kind === 'D' ? 'del' : 'pick';
    var btnLabel = item.actionLabel || (item.kind === 'D' ? 'Delivered' : 'Picked Up');

    return [
      '<div class="card ' + done + '" data-uid="' + item.uid + '" data-kind="' + item.kind + '">',
        '<div class="row">',
          '<div>',
            '<div class="h">' + item.name + ' <span class="badge">' + (item.equipment || '') + '</span></div>',
            '<div class="muted">' + kindTxt + ' • ' + win + ' • ' + (item.source || '') + '</div>',
            '<div class="muted">' + (item.address || '') + '</div>',
          '</div>',
          '<div>',
            '<button class="action ' + btnClass + '" onclick="doAction(\'' + item.uid + '\',\'' + item.kind + '\')">' + btnLabel + '</button>',
          '</div>',
        '</div>',
        '<div class="row-ops">',
          '<a class="btn" href="' + mapsLink(item.address) + '" target="_blank">Navigate</a>',
        '</div>',
      '</div>'
    ].join('');
  }

  function render(items) {
    var list = document.getElementById('list');
    if (!items.length) {
      list.innerHTML = '<div class="empty">No items.</div>';
      return;
    }
    list.innerHTML = items.map(card).join('');
  }

  async function load() {
    var date = document.getElementById('date').value || todayISO();
    var url = WEB_APP_URL + '?date=' + encodeURIComponent(date) + '&type=' + encodeURIComponent(currentType);
    var res = await fetch(url);
    var data = await res.json();
    if (!data.ok) throw new Error(data.message || 'Load failed');
    render(data.items || []);
  }

  async function doAction(uid, kind) {
    var cardEl = document.querySelector('.card[data-uid="' + uid + '"]');
    var btn = cardEl.querySelector('button.action');
    var prev = btn.textContent;
    var action = (kind === 'D') ? 'Delivered' : 'Picked Up';
    btn.textContent = action + ' ...';
    try {
      var body = new URLSearchParams({ uid: uid, action: action });
      var res = await fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: body
      });
      var data = await res.json();
      if (!data.ok) throw new Error(data.message || 'Update failed');
      btn.textContent = action + ' ✔';
      cardEl.classList.add('done');
    } catch (e) {
      alert('Update failed: ' + e.message);
      btn.textContent = prev;
    }
  }

  // init
  var dateInput = document.getElementById('date');
  dateInput.value = todayISO();
  dateInput.addEventListener('change', load);

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js').catch(function(){});
  }
  load().catch(function(e) {
    document.getElementById('list').innerHTML = '<div class="empty">Error: ' + e.message + '</div>';
  });
</script>
